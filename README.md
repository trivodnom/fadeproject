Документация по проекту FadeProject
1. Обзор проекта
FadeProject — это веб-приложение для проведения турниров по прогнозам на спортивные матчи. Пользователи могут регистрироваться, пополнять баланс, участвовать в турнирах, делая прогнозы на исходы матчей, и соревноваться за призовой фонд, формирующийся из вступительных взносов.

Проект спроектирован с акцентом на модульность и расширяемость, что позволяет в будущем легко добавлять новые виды спорта или изменять правила.

1.1. Технологический стек
Бэкенд: Python 3.10, Flask
База данных: SQLAlchemy (ORM), SQLite (для разработки), Flask-Migrate (для миграций)
Аутентификация: Flask-Login
Админ-панель: Flask-Admin
Формы: Flask-WTF
Загрузка файлов: Flask-Uploads
Фронтенд: HTML, CSS, JavaScript (jQuery), Jinja2 (шаблонизатор), Bootstrap 4 (тема Black Dashboard)
Внешнее API: api-football-v1.p.rapidapi.com для получения информации о матчах.
2. Структура проекта
Проект использует "фабрику приложений" и "блюпринты" (Blueprints) для логического разделения функционала.

/fadeproject
|
|-- app/                      # Основная папка приложения
|   |-- __init__.py           # Фабрика приложения: создает app, инициализирует расширения, регистрирует блюпринты.
|   |-- api_client.py         # Логика для работы с внешним API (получение матчей).
|   |-- decorators.py         # Кастомные декораторы (например, для проверки прав админа).
|   |-- models.py             # Модели базы данных (SQLAlchemy).
|   |-- routes.py             # Основные маршруты (главная страница, dashboard).
|   |-- util.py               # Вспомогательные функции (форматирование даты, генерация URL).
|   |-- extensions.py         # Инициализация расширений, которые требуют импорта до app (например, Flask-Uploads).
|   |
|   |-- auth/                 # Модуль аутентификации (регистрация, вход, выход).
|   |   |-- __init__.py       # Определение блюпринта 'auth_bp'.
|   |   |-- forms.py          # Формы для логина и регистрации.
|   |   +-- routes.py         # Маршруты /login, /register, /logout.
|   |
|   |-- profile/              # Модуль профиля пользователя.
|   |   |-- __init__.py       # Определение блюпринта 'profile_bp'.
|   |   |-- forms.py          # Формы для редактирования профиля.
|   |   +-- routes.py         # Маршрут /profile/.
|   |
|   |-- tournament/           # Главный модуль: все, что связано с турнирами.
|   |   |-- __init__.py       # Определение блюпринта 'tournament_bp'.
|   |   |-- forms.py          # Формы для создания турнира и прогнозов.
|   |   |-- utils.py          # Важная бизнес-логика: подсчет очков, распределение призов.
|   |   +-- routes.py         # Все маршруты турниров.
|   |
|   +-- templates/            # HTML-шаблоны.
|       |-- includes/         # Переиспользуемые части (шапка, сайдбар, подвал).
|       |-- admin/            # Кастомные шаблоны для админки.
|       |-- auth/
|       |-- profile/
|       |-- tournament/
|       +-- base.html         # Главный базовый шаблон, от которого наследуются все остальные.
|
|-- migrations/               # Файлы миграций базы данных (генерируются Flask-Migrate).
|-- venv/                     # Виртуальное окружение (не отслеживается Git).
|-- run.py                    # Точка входа для запуска приложения.
|-- config.py                 # Конфигурационные переменные.
|-- manage.py                 # Скрипт для выполнения командных операций (выдача прав админа).
+-- requirements.txt          # Список зависимостей Python.
3. Модели данных (app/models.py)
Основа всего приложения. Описывает, как данные хранятся в базе.

User: Пользователь системы.

Ключевые поля: username, email, password_hash, role ('user' или 'admin'), balance, avatar.
Связи:
tournaments: к каким турнирам присоединился пользователь (связь многие-ко-многим через таблицу participants).
predictions: все прогнозы, сделанные этим пользователем.
balance_history: вся история изменения баланса.
Tournament: Турнир.

Ключевые поля: name, description, entry_fee, start_date, end_date, status (draft, open, active, finished, cancelled), max_participants, prize_places.
matches_json: Важнейшее поле. Хранит JSON-строку со списком всех матчей, полученных из внешнего API. Это позволяет не делать повторные запросы к API для уже созданного турнира.
Связи:
attendees: все пользователи, участвующие в турнире.
predictions: все прогнозы, сделанные в рамках этого турнира.
Prediction: Прогноз пользователя на матч.

Ключевые поля: user_id, tournament_id, match_id (ID матча из API).
home_score_prediction, away_score_prediction: прогноз пользователя.
home_score_actual, away_score_actual: реальный счет матча (вводится админом).
points_awarded: очки, начисленные за прогноз после завершения матча.
BalanceHistory: Запись об изменении баланса.

Создается при каждом списании (вход в турнир) или начислении (выход из турнира, получение приза).
Схема связей:
+----------+       +----------------+       +------------+
|   User   |-------|  participants  |-------| Tournament |
+----------+       +----------------+       +------------+
    |                    (m-to-m)                 |
    |                                             |
    | (1-to-m)                                    | (1-to-m)
    v                                             v
+------------+                               +-------------+
| BalanceH.  |                               | Prediction  |
+------------+                               +-------------+
     ^                                            ^
     | (m-to-1)                                   | (m-to-1)
     +--------------------------------------------+
4. Ключевые сценарии и логика
4.1. Создание турнира (администратором)
Шаг 1 (Детали): Админ открывает /tournaments/create. Заполняет форму TournamentCreationForm (название, взнос и т.д.).
Файлы: tournament/routes.py (функция create_tournament), tournament/forms.py, templates/tournament/create_step1.html.
Шаг 2 (Выбор матчей): После отправки формы админ попадает на /tournaments/<id>/select_matches.
JavaScript на этой странице позволяет выбрать лигу. При выборе отправляется AJAX-запрос на /tournaments/get_matches/<league_id>.
api_client.py (функция get_matches_for_league) запрашивает у внешнего API список матчей.
JavaScript отрисовывает полученные матчи. Админ кликает на кнопки "Add".
Когда админ нажимает "Finish and Create Tournament", JavaScript собирает все выбранные матчи в один JSON-массив и помещает его в скрытое поле формы.
Форма отправляется POST-запросом на /tournaments/<id>/select_matches.
tournament/routes.py (функция select_matches) сохраняет этот JSON в поле Tournament.matches_json, определяет дату начала/конца турнира и меняет его статус на 'open'.
Файлы: tournament/routes.py, api_client.py, templates/tournament/create_step2.html.
4.2. Участие в турнире и прогнозы
Просмотр: Пользователь заходит на /tournaments/<id> (tournament_details). Функция-обработчик загружает турнир, матчи из matches_json, прогнозы пользователя и строит лидерборд.
Вступление: Пользователь нажимает "Join". Форма отправляет POST-запрос на /tournaments/<id>/action.
Функция join_or_leave_tournament проверяет баланс, наличие мест, списывает деньги и добавляет пользователя в tournament.attendees. Создается запись в BalanceHistory.
Прогноз: Пользователь нажимает "Predict" или "Edit". URL меняется (добавляются ?action=edit&match_id=...), страница перезагружается и в нужной строке таблицы появляется форма для ввода счета.
При сохранении форма отправляет POST-запрос на /tournaments/<id>/predict.
Функция make_prediction находит или создает запись Prediction и сохраняет в нее прогноз.
4.3. Подведение итогов (администратором)
Ввод результатов: Админ заходит на кастомную страницу /admin/tournament/<id>/manage.
Функция manage_tournament загружает матчи из matches_json и предзаполняет поля, если результаты уже были введены.
Админ вводит счета и нажимает "Save Scores".
manage_tournament обрабатывает POST-запрос. Для каждого матча она находит все прогнозы (Prediction) и для каждого прогноза вызывает calculate_points из app/tournament/utils.py, обновляя поле points_awarded.
Завершение турнира и раздача призов:
На той же странице админ меняет статус турнира на 'finished' и нажимает "Update Status".
manage_tournament видит смену статуса и перед сохранением вызывает функцию distribute_prizes_for_tournament.
distribute_prizes_for_tournament:
Получает финальный лидерборд.
Группирует игроков с одинаковым количеством очков.
Вызывает calculate_prize_distribution из utils.py, чтобы получить схему призов.
Справедливо делит призы между игроками, которые поделили места.
Начисляет деньги на баланс (user.balance += ...) и создает запись в BalanceHistory.
Перераспределение: Если админ ошибся, он может нажать кнопку "Redistribute Prizes", которая вызывает роут /admin/tournament/<id>/redistribute. Эта функция сначала отменяет все транзакции по призам для этого турнира, а затем заново запускает distribute_prizes_for_tournament.
5. Настройка и запуск
Клонировать репозиторий: git clone ...
Создать и активировать виртуальное окружение:
python3.10 -m venv venv
source venv/bin/activate
Установить зависимости: pip install -r requirements.txt
Создать файл .env в корневой папке проекта и прописать в нем переменные:
SECRET_KEY='ваш_супер_секретный_ключ'
API_HOST='v3.football.api-sports.io'
API_KEY='ваш_ключ_от_api-football'
# DATABASE_URL='postgresql://...' # Если будете использовать другую БД
Инициализировать базу данных:
flask db init  # (только при первой настройке)
flask db migrate -m "Initial migration"
flask db upgrade
Запустить приложение: flask run
Создать админа (если нужно):
python3.10 manage.py create-admin <имя> <email> <пароль>
Финальный совет для новичка: Если что-то идет не так, в первую очередь смотрите в лог ошибок (error.log на PythonAnywhere). 99% проблем оставляют там свой след. Начните отладку с изучения моделей (models.py) и маршрутов (routes.py), так как это ядро приложения.