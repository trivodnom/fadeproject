{% extends "base.html" %}

{% block page_title %}Select Matches for {{ tournament.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <!-- БЛОК ВЫБОРА СПОРТА -->
        <div class="card">
            <div class="card-header"><h5 class="card-title">Sport</h5></div>
            <div class="card-body">
                <div class="form-group">
                    <label for="sport-selector">Select a Sport</label>
                    <!-- Атрибут form="finish-form" связывает этот селектор с формой отправки -->
                    <select id="sport-selector" name="sport" form="finish-form" class="form-control">
                        {% for sport_key, sport_name in sports.items() %}
                            <option value="{{ sport_key }}" {{ 'selected' if tournament.sport == sport_key or not tournament.sport and loop.first }}>{{ sport_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><h5 class="card-title">Leagues</h5></div>
            <div class="card-body">
                <div class="form-group">
                    <label for="league-selector">Select a League</label>                    <select id="league-selector" class="form-control">
                        <option selected disabled>Choose here...</option>
                        {% for league_name, league_id in leagues.items() %}
                            <option value="{{ league_id }}">{{ league_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h5 class="card-title">Selected Matches</h5></div>
            <div class="card-body" id="selected-matches-container">
                <p>No matches selected yet.</p>
                <ul class="list-unstyled" id="selected-list"></ul>
            </div>
        </div>
    </div>
    <div class="col-md-8">
         <div class="card">
            <div class="card-header"><h5 class="card-title">Available Matches</h5></div>
            <div class="card-body" id="matches-container">
                <p>Select a league to see available matches.</p>
            </div>
        </div>
    </div>
</div>
<hr>
<div class="row">
    <div class="col-12 text-center">
        <form id="finish-form" action="{{ url_for('tournaments.select_matches', tournament_id=tournament.id) }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="selected_matches_json" id="selected_matches_json">
            <button type="submit" class="btn btn-fill btn-success">Finish and Create Tournament</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function(){
    var selectedMatches = {};

    function renderSelectedMatches() {
        var list = $('#selected-list');
        var container = $('#selected-matches-container');
        list.empty();
        if (Object.keys(selectedMatches).length === 0) {
            container.find('p').show();
        } else {
            container.find('p').hide();
            $.each(selectedMatches, function(id, match){
                var listItem = $('<li class="d-flex justify-content-between align-items-center mb-2">');
                var matchDate = new Date(match.fixture.date);
                var formattedDate = matchDate.toLocaleString('ru-RU', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
                var leagueInfo = match.league.name + ' - ' + match.league.round;
                listItem.html('<span>' + match.teams.home.name + ' vs ' + match.teams.away.name + '<br><small class="text-muted">' + leagueInfo + ' | ' + formattedDate + '</small></span>');
                var removeBtn = $('<button type="button" class="btn btn-danger btn-sm">&times;</button>');
                removeBtn.data('match-id', id);
                listItem.append(removeBtn);
                list.append(listItem);
            });
        }
    }

    $('#league-selector').on('change', function(e){
        var leagueId = $(this).val();
        var matchesContainer = $('#matches-container');
        matchesContainer.html('<p>Loading matches...</p>');

        $.getJSON('/tournaments/get_matches/' + leagueId, function(data) {
            matchesContainer.empty();
            if (data && Array.isArray(data) && data.length > 0) {
                var accordion = $('<div class="accordion" id="roundsAccordion"></div>');

                $.each(data, function(index, roundData) {
                    var roundName = roundData[0];
                    var matchesInRound = roundData[1];
                    var roundId = 'round-' + index;

                    var card = $('<div class="card mb-1"></div>');
                    var cardHeader = $('<div class="card-header">' +
                        '<h5 class="mb-0">' +
                        '<button class="btn btn-link btn-block text-left text-white" type="button" data-toggle="collapse" data-target="#' + roundId + '">' +
                        roundName +
                        '</button>' +
                        '</h5>' +
                        '</div>');

                    var collapse = $('<div id="' + roundId + '" class="collapse ' + (index === 0 ? 'show' : '') + '" data-parent="#roundsAccordion"></div>');
                    var cardBody = $('<div class="card-body"></div>');
                    var table = $('<table class="table table-hover"><tbody></tbody></table>');

                    $.each(matchesInRound, function(i, match){
                        var row = $('<tr>');
                        var cell = $('<td class="d-flex justify-content-between align-items-center"></td>');
                        var matchDateUTC = new Date(match.fixture.date);
                        var matchDateMSK = new Date(matchDateUTC.getTime() + (3 * 60 * 60 * 1000));
                        var formattedDate = matchDateMSK.toLocaleString('ru-RU', { timeZone: 'Europe/Moscow', day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
                        cell.html('<span>' + match.teams.home.name + ' vs ' + match.teams.away.name + '<br><small class="text-muted">' + formattedDate + '</small></span>');

                        var addButton = $('<button type="button" class="btn btn-primary btn-sm">Add</button>');
                        addButton.data('match-info', match);
                        if(selectedMatches[match.fixture.id]){
                            addButton.prop('disabled', true).text('Added');
                        }
                        cell.append(addButton);
                        row.append(cell);
                        table.find('tbody').append(row);
                    });

                    cardBody.append(table);
                    collapse.append(cardBody);
                    card.append(cardHeader).append(collapse);
                    accordion.append(card);
                });
                matchesContainer.append(accordion);
            } else {
                matchesContainer.html('<p>No available matches found for this league.</p>');
            }
        }).fail(function() {
            matchesContainer.html('<p class="text-danger">Error loading matches.</p>');
        });
    });

    $('#matches-container').on('click', '.btn-primary', function() {
        var matchInfo = $(this).data('match-info');
        selectedMatches[matchInfo.fixture.id] = matchInfo;
        $(this).prop('disabled', true).text('Added');
        renderSelectedMatches();
    });

    $('#selected-matches-container').on('click', '.btn-danger', function() {
        var matchId = $(this).data('match-id');
        delete selectedMatches[matchId];
        renderSelectedMatches();
        $('#matches-container button').filter(function() {
            var matchInfo = $(this).data('match-info');
            return matchInfo && matchInfo.fixture.id == matchId;
        }).prop('disabled', false).text('Add');
    });

    $('#finish-form').on('submit', function(){
        $('#selected_matches_json').val(JSON.stringify(Object.values(selectedMatches)));
    });
});
</script>
{% endblock %}