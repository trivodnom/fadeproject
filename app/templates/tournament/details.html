{% extends "base.html" %}

{% block page_title %}{{ tournament.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header"><h4 class="card-title">Matches</h4></div>
            <div class="card-body">
                {% if grouped_matches %}
                <div class="accordion" id="leaguesAccordion">
                    {% for league_name, rounds in grouped_matches.items() %}
                    <div class="card bg-dark mb-1">
                        <div class="card-header" id="heading-{{ loop.index }}">
                            <h5 class="mb-0">
                                <button class="btn btn-link text-white" type="button" data-toggle="collapse" data-target="#collapse-{{ loop.index }}" aria-expanded="{{ 'true' if loop.first else 'false' }}">
                                    {{ league_name }}
                                </button>
                            </h5>
                        </div>
                        <div id="collapse-{{ loop.index }}" class="collapse {{ 'show' if loop.first }}" data-parent="#leaguesAccordion">
                            <div class="card-body">
                                {% for round_name, matches in rounds.items() %}
                                    <h6 class="mt-3 text-muted">{{ round_name }}</h6>
                                    <div class="table-responsive">
                                        <table class="table tablesorter">
                                            <thead class="text-primary"><tr><th>Date</th><th>Match</th><th class="text-center">Result</th><th class="text-center">Your Prediction</th><th class="text-center">Points</th></tr></thead>
                                            <tbody>
                                                {% for match in matches %}
                                                    <tr id="match-{{ match.fixture.id }}">
                                                        <td>{{ match.fixture.date | format_datetime }}</td>
                                                        <td><img src="{{ match.teams.home.logo }}" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 5px;"> {{ match.teams.home.name }} vs {{ match.teams.away.name }} <img src="{{ match.teams.away.logo }}" style="width: 24px; height: 24px; vertical-align: middle; margin-left: 5px;"></td>
                                                        <td class="text-center">
                                                            {% set prediction = user_predictions.get(match.fixture.id | string) %}
                                                            {% if prediction and prediction.home_score_actual is not none %}
                                                                <strong>{{ prediction.home_score_actual }} : {{ prediction.away_score_actual }}</strong>
                                                            {% else %}
                                                                - : -
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% if current_user.is_authenticated and tournament in current_user.tournaments %}
                                                                {% set prediction = user_predictions.get(match.fixture.id | string) %}
                                                                {% if dateutil.parser.isoparse(match.fixture.date) > datetime.now(timezone.utc) %}
                                                                    <!-- Включен режим редактирования для этого матча? -->
                                                                    {% if request.args.get('action') == 'edit' and request.args.get('match_id') == (match.fixture.id | string) %}

                                                                        <!-- ===== НАЧАЛО ИСПРАВЛЕНИЯ ===== -->
                                                                        <!-- Здесь должна быть форма для ввода счета, а не кнопка "Leave" -->
                                                                        <form action="{{ url_for('tournaments.make_prediction', tournament_id=tournament.id) }}" method="post" class="form-inline justify-content-center">
                                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                                            <input type="hidden" name="match_id" value="{{ match.fixture.id }}">
                                                                            <input type="number" name="home_score_{{ match.fixture.id }}" class="form-control form-control-sm" style="width: 60px;" value="{{ prediction.home_score_prediction if prediction else '' }}" min="0">
                                                                            <span class="mx-2">:</span>
                                                                            <input type="number" name="away_score_{{ match.fixture.id }}" class="form-control form-control-sm" style="width: 60px;" value="{{ prediction.away_score_prediction if prediction else '' }}" min="0">
                                                                            <button type="submit" class="btn btn-primary btn-sm ml-2">Save</button>
                                                                        </form>
                                                                        <!-- ===== КОНЕЦ ИСПРАВЛЕНИЯ ===== -->

                                                                    {% else %}
                                                                        <!-- Показываем прогноз или кнопку "Edit/Predict" -->
                                                                        {% if prediction %}
                                                                            <strong>{{ prediction.home_score_prediction }} : {{ prediction.away_score_prediction }}</strong>
                                                                            <a href="{{ url_for('tournaments.tournament_details', tournament_id=tournament.id, action='edit', match_id=match.fixture.id, _anchor='match-' ~ match.fixture.id) }}" class="btn btn-info btn-sm ml-2">Edit</a>
                                                                        {% else %}
                                                                            <a href="{{ url_for('tournaments.tournament_details', tournament_id=tournament.id, action='edit', match_id=match.fixture.id, _anchor='match-' ~ match.fixture.id) }}" class="btn btn-primary btn-sm ml-2">Predict</a>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                {% else %}
                                                                    <!-- Матч уже начался, показываем прогноз без возможности редактирования -->
                                                                    {% if prediction and prediction.home_score_prediction is not none %}
                                                                        <strong>{{ prediction.home_score_prediction }} : {{ prediction.away_score_prediction }}</strong>
                                                                    {% else %}
                                                                        - : -
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% else %}
                                                                - : -
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% if prediction and prediction.points_awarded > 0 %}
                                                                <strong style="color: #00f2c3;">+{{ prediction.points_awarded }}</strong>
                                                            {% elif prediction and prediction.home_score_actual is not none %}
                                                                0
                                                            {% else %}
                                                                -
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p>There are no matches for this tournament.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header"><h4 class="card-title">{{ tournament.name }}</h4></div>
            <div class="card-body">
                {% set status_map = {'open': 'badge-success', 'active': 'badge-primary', 'finished': 'badge-secondary', 'cancelled': 'badge-danger'} %}
                <span class="badge badge-pill {{ status_map.get(tournament.status, 'badge-light') }} float-right">{{ tournament.status.title() }}</span>
                <p>{{ tournament.description }}</p>
                <hr>
                <p><strong>Entry Fee:</strong> {{ tournament.entry_fee }}</p>
                <p><strong>Prize Places:</strong> {{ tournament.prize_places }}</p>
                <p><strong>Participants:</strong> {{ num_attendees }} / {{ tournament.max_participants or 'Unlimited' }}</p>
                <p><strong>Total Prize Pool:</strong> {{ tournament.entry_fee * num_attendees }}</p>
                <p><strong>Platform Fee (10%):</strong> {{ platform_fee | round(2) }}</p>
                <p><strong>Net Prize Pool:</strong> {{ (tournament.entry_fee * num_attendees) - platform_fee | round(2) }}</p>
                <hr>
                <h5>Prize Distribution:</h5>
                <ul>
                    {% for prize in prize_distribution %}
                        <li>{{ prize }}</li>
                    {% endfor %}
                </ul>
                <hr>
                {% if current_user.is_authenticated %}
                    {% if tournament in current_user.tournaments %}
                        <button type="button" class="btn btn-outline-success btn-block" disabled>You have joined</button>

                        <!-- Этот блок теперь на своем месте и работает правильно -->
                        {% set can_leave = [True] %}
                        {% if tournament.status not in ['open', 'upcoming'] %}
                            {% if can_leave.pop() %}{% endif %}
                        {% endif %}
                        {% if first_match_start_time and now_utc >= first_match_start_time %}
                             {% if can_leave.pop() %}{% endif %}
                        {% endif %}

                        <form action="{{ url_for('tournaments.join_or_leave_tournament', tournament_id=tournament.id) }}" method="post" class="mt-2" onsubmit="return confirm('Are you sure you want to leave this tournament? Your entry fee will be refunded.');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" name="action" value="leave" class="btn btn-danger btn-block"
                                    {% if not can_leave %}
                                        disabled
                                        title="You can no longer leave this tournament as it has already started."
                                    {% endif %}>
                                Leave Tournament
                            </button>
                        </form>
                    {% else %}
                        <form action="{{ url_for('tournaments.join_or_leave_tournament', tournament_id=tournament.id) }}" method="post" id="join-leave-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            {% set can_join = True %}
                            {% set reason = '' %}
                            {% if tournament.status not in ['open', 'upcoming'] %}
                                {% set can_join = False %}
                                {% set reason = 'This tournament is not open for joining.' %}
                            {% elif tournament.max_participants and num_attendees >= tournament.max_participants %}
                                {% set can_join = False %}
                                {% set reason = 'The tournament is full.' %}
                            {% elif current_user.balance < tournament.entry_fee %}
                                {% set can_join = False %}
                                {% set reason = 'You do not have enough funds to join. Required: ' ~ tournament.entry_fee ~ ', you have: ' ~ current_user.balance %}
                            {% endif %}

                            <button type="submit" name="action" value="join" class="btn btn-success btn-block" {% if not can_join %}disabled title="{{ reason }}"{% endif %}>
                                Join Tournament
                            </button>
                        </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h4 class="card-title">Prize rules</h4></div>
            <div class="card-body">
                <h6>Как делятся призы при ничьей?</h6>
                <p>Если несколько участников набирают одинаковое количество очков и претендуют на призовые места, происходит следующее:</p>
                <ol>
                    <li><strong>Призы суммируются.</strong> Все призовые деньги за места, которые делят игроки, складываются вместе.
                        <br><em>Пример: Два игрока делят 1-е место. Мы берем приз за 1-е и 2-е места и складываем их.</em>
                    </li>
                    <li><strong>Сумма делится поровну.</strong> Получившаяся общая сумма делится поровну между всеми игроками, набравшими одинаковое количество очков.</li>
                    <li><strong>Следующие места пропускаются.</strong> Следующий по очкам игрок займет место, идущее сразу за последним из "поделивших".
                        <br><em>Пример: Если двое поделили 1-е место, то следующий игрок в таблице лидеров занимает уже 3-е место.</em>
                    </li>
                </ol>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h4 class="card-title">Points rules</h4></div>
            <div class="card-body">
                <ul>
                    <li><strong>5 очков:</strong> За точно угаданный счет.</li>
                    <li><strong>3 очка:</strong> За угаданный исход матча и разницу мячей.</li>
                    <li><strong>2 очка:</strong> За угаданный исход матча (победа, поражение или ничья).</li>
                    <li><strong>1 очко:</strong> За угаданное количество голов одной из команд.</li>
                </ul>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h4 class="card-title">Leaderboard</h4></div>
            <div class="card-body">
                <table class="table tablesorter">
                    <thead class="text-primary"><tr><th>Rank</th><th>User</th><th>Points</th></tr></thead>
                    <tbody>
                        {% for username, points in leaderboard %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ username }}</td>
                            <td>{{ points or 0 }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="3">No participants yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const joinButton = document.querySelector('button[data-cant-join="true"]');
    if (joinButton) {
        joinButton.addEventListener('click', function(e) {
            e.preventDefault();
            alert(this.dataset.reason);
        });
    }
});
</script>
{% endblock %}